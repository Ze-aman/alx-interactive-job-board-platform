// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

datasource db {
  provider = "mysql"
}

generator client {
  provider = "prisma-client"
}

// ==========================================
// 1. AUTH & USER MANAGEMENT
// ==========================================

model Role {
  id         BigInt   @id @default(autoincrement())
  name       String   @unique @db.VarChar(50)
  created_at DateTime @default(now()) @db.Timestamp(0)
  users      User[]

  @@map("roles")
}

model User {
  id                 BigInt                @id @default(autoincrement())
  email              String                @unique @db.VarChar(255)
  password_hash      String                @db.VarChar(255)
  role_id            BigInt
  status             UserStatus            @default(active)
  last_login_at      DateTime?             @db.DateTime(0)
  created_at         DateTime              @default(now()) @db.Timestamp(0)
  
  role               Role                  @relation(fields: [role_id], references: [id])
  candidate_profile  CandidateProfile?
  resumes            Resume[]
  company_users      CompanyUser[]
  password_tokens    PasswordResetToken[]
  notifications      Notification[]
  sent_messages      Message[]             @relation("SentMessages")
  received_messages  Message[]             @relation("ReceivedMessages")
  applications       JobApplication[]

  @@map("users")
}

enum UserStatus {
  active
  suspended
  deleted
}

model PasswordResetToken {
  id         BigInt    @id @default(autoincrement())
  user_id    BigInt
  token      String    @unique @db.VarChar(255)
  expires_at DateTime  @db.DateTime(0)
  used_at    DateTime? @db.DateTime(0)
  user       User      @relation(fields: [user_id], references: [id])

  @@map("password_reset_tokens")
}

// ==========================================
// 2. CANDIDATES
// ==========================================

model CandidateProfile {
  user_id   BigInt  @id
  full_name String? @db.VarChar(255)
  phone     String? @db.VarChar(30)
  location  String? @db.VarChar(255)
  bio       String? @db.Text
  user      User    @relation(fields: [user_id], references: [id])

  @@map("candidate_profiles")
}

model Resume {
  id           BigInt           @id @default(autoincrement())
  candidate_id BigInt
  file_path    String?          @db.VarChar(500)
  file_type    String?          @db.VarChar(50)
  uploaded_at  DateTime         @default(now()) @db.Timestamp(0)
  candidate    User             @relation(fields: [candidate_id], references: [id])
  applications JobApplication[]

  @@map("resumes")
}

// ==========================================
// 3. EMPLOYERS & COMPANIES
// ==========================================

model Company {
  id            BigInt        @id @default(autoincrement())
  name          String        @db.VarChar(255)
  industry      String?       @db.VarChar(255)
  location      String?       @db.VarChar(255)
  verified      Boolean       @default(false)
  created_at    DateTime      @default(now()) @db.Timestamp(0)
  users         CompanyUser[]
  jobs          Job[]
  subscriptions Subscription[]

  @@map("companies")
}

model CompanyUser {
  user_id    BigInt
  company_id BigInt
  role       CompanyRole
  user       User        @relation(fields: [user_id], references: [id])
  company    Company     @relation(fields: [company_id], references: [id])

  @@id([user_id, company_id])
  @@map("company_users")
}

enum CompanyRole {
  owner
  recruiter
  hr
}

// ==========================================
// 4. JOB POSTINGS
// ==========================================

model Job {
  id              BigInt              @id @default(autoincrement())
  company_id      BigInt
  title           String?             @db.VarChar(255)
  department      String?             @db.VarChar(255)
  employment_type String?             @db.VarChar(50)
  location        String?             @db.VarChar(255)
  salary_min      Decimal?            @db.Decimal(12, 2)
  salary_max      Decimal?            @db.Decimal(12, 2)
  status          JobStatus           @default(draft)
  published_at    DateTime?           @db.DateTime(0)
  created_at      DateTime            @default(now()) @db.Timestamp(0)
  
  company         Company             @relation(fields: [company_id], references: [id])
  description     JobDescription?
  requirements    JobRequirement[]
  responsibilities JobResponsibility[]
  applications    JobApplication[]

  @@map("jobs")
}

enum JobStatus {
  draft
  published
  closed
}

model JobDescription {
  job_id           BigInt  @id
  description_html String? @db.LongText
  job              Job     @relation(fields: [job_id], references: [id])

  @@map("job_descriptions")
}

model JobRequirement {
  id               BigInt  @id @default(autoincrement())
  job_id           BigInt?
  requirement_text String? @db.Text
  job              Job?    @relation(fields: [job_id], references: [id])

  @@map("job_requirements")
}

model JobResponsibility {
  id                  BigInt  @id @default(autoincrement())
  job_id              BigInt?
  responsibility_text String? @db.Text
  job                 Job?    @relation(fields: [job_id], references: [id])

  @@map("job_responsibilities")
}

// ==========================================
// 5. APPLICATIONS (ATS)
// ==========================================

model JobApplication {
  id           BigInt              @id @default(autoincrement())
  job_id       BigInt?
  candidate_id BigInt?
  resume_id    BigInt?
  status       ApplicationStatus   @default(applied)
  applied_at   DateTime            @default(now()) @db.Timestamp(0)
  
  job          Job?                @relation(fields: [job_id], references: [id])
  candidate    User?               @relation(fields: [candidate_id], references: [id])
  resume       Resume?             @relation(fields: [resume_id], references: [id])
  history      ApplicationStatusHistory[]

  @@map("job_applications")
}

enum ApplicationStatus {
  applied
  shortlisted
  rejected
  hired
}

model ApplicationStatusHistory {
  id             BigInt         @id @default(autoincrement())
  application_id BigInt?
  status         String?        @db.VarChar(50)
  changed_by     BigInt?
  changed_at     DateTime       @default(now()) @db.Timestamp(0)
  application    JobApplication? @relation(fields: [application_id], references: [id])

  @@map("application_status_history")
}

// ==========================================
// 6. COMMUNICATION & NOTIFICATIONS
// ==========================================

model Notification {
  id         BigInt    @id @default(autoincrement())
  user_id    BigInt?
  type       String?   @db.VarChar(100)
  message    String?   @db.Text
  read_at    DateTime? @db.DateTime(0)
  created_at DateTime  @default(now()) @db.Timestamp(0)
  user       User?     @relation(fields: [user_id], references: [id])

  @@map("notifications")
}

model Message {
  id           BigInt   @id @default(autoincrement())
  sender_id    BigInt?
  receiver_id  BigInt?
  message_text String?  @db.Text
  sent_at      DateTime @default(now()) @db.Timestamp(0)
  sender       User?    @relation("SentMessages", fields: [sender_id], references: [id])
  receiver     User?    @relation("ReceivedMessages", fields: [receiver_id], references: [id])

  @@map("messages")
}

// ==========================================
// 7. ADMIN & AUDIT
// ==========================================

model AdminAction {
  id          BigInt   @id @default(autoincrement())
  admin_id    BigInt?
  action_type String?  @db.VarChar(100)
  target_type String?  @db.VarChar(100)
  target_id   BigInt?
  created_at  DateTime @default(now()) @db.Timestamp(0)

  @@map("admin_actions")
}

model ModerationLog {
  id            BigInt            @id @default(autoincrement())
  moderator_id  BigInt?
  entity_type   String?           @db.VarChar(100)
  entity_id     BigInt?
  decision      ModerationDecision?
  reason        String?           @db.Text
  created_at    DateTime          @default(now()) @db.Timestamp(0)

  @@map("moderation_logs")
}

enum ModerationDecision {
  approved
  rejected
}

// ==========================================
// 8. ANALYTICS & BILLING
// ==========================================

model JobView {
  job_id    BigInt   @id // Simplified for Prisma; typically views don't have PKs but Prisma requires one
  viewed_at DateTime @default(now()) @db.Timestamp(0)
  viewer_ip String?  @db.VarChar(45)

  @@map("job_views")
}

model Subscription {
  id         BigInt             @id @default(autoincrement())
  company_id BigInt?
  plan_name  String?            @db.VarChar(100)
  start_date DateTime?          @db.Date
  end_date   DateTime?          @db.Date
  status     SubscriptionStatus?
  company    Company?           @relation(fields: [company_id], references: [id])

  @@map("subscriptions")
}

enum SubscriptionStatus {
  active
  expired
  cancelled
}
